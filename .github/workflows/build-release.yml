name: Build Release Binaries

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: Install dependencies (server)
      run: bun install --frozen-lockfile

    - name: Install dependencies (client)
      run: cd client && bun install --frozen-lockfile

    - name: Build client
      run: bun run build:client

    - name: Embed static files
      run: bun run embed-static

    - name: Generate version file
      run: bun run generate-version

    - name: Build all platforms
      run: |
        mkdir -p dist
        bun build --compile --minify --define 'process.env.NODE_ENV="production"' --target=bun-linux-x64 --outfile=dist/gowa-manager-linux-x64 src/index.ts
        bun build --compile --minify --define 'process.env.NODE_ENV="production"' --target=bun-linux-arm64 --outfile=dist/gowa-manager-linux-arm64 src/index.ts
        bun build --compile --minify --define 'process.env.NODE_ENV="production"' --target=bun-darwin-x64 --outfile=dist/gowa-manager-macos-x64 src/index.ts
        bun build --compile --minify --define 'process.env.NODE_ENV="production"' --target=bun-darwin-arm64 --outfile=dist/gowa-manager-macos-arm64 src/index.ts
        bun build --compile --minify --define 'process.env.NODE_ENV="production"' --target=bun-windows-x64 --outfile=dist/gowa-manager-windows-x64.exe src/index.ts

    - name: Create checksums
      run: |
        cd dist
        sha256sum gowa-manager-* > checksums.txt
        cat checksums.txt

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: gowa-manager-binaries
        path: |
          dist/gowa-manager-*
          dist/checksums.txt

    - name: Get tag message
      if: startsWith(github.ref, 'refs/tags/')
      id: tag_message
      run: |
        # Get the annotated tag message (excludes the tag name line)
        TAG_MESSAGE=$(git tag -l --format='%(contents)' ${{ github.ref_name }})
        # Handle multi-line message for GitHub Actions
        echo "message<<EOF" >> $GITHUB_OUTPUT
        echo "$TAG_MESSAGE" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist/gowa-manager-linux-x64
          dist/gowa-manager-linux-arm64
          dist/gowa-manager-macos-x64
          dist/gowa-manager-macos-arm64
          dist/gowa-manager-windows-x64.exe
          dist/checksums.txt
        draft: false
        prerelease: false
        body: |
          ${{ steps.tag_message.outputs.message }}

          ---

          ## Quick Start

          ```bash
          npx gowa-manager
          ```

          Automatically downloads the correct binary for your platform and runs it.

          <details>
          <summary>Manual Download (Alternative)</summary>

          | Platform | Binary |
          |----------|--------|
          | Linux x64 | `gowa-manager-linux-x64` |
          | Linux ARM64 | `gowa-manager-linux-arm64` |
          | macOS Intel | `gowa-manager-macos-x64` |
          | macOS Apple Silicon | `gowa-manager-macos-arm64` |
          | Windows x64 | `gowa-manager-windows-x64.exe` |

          </details>
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
